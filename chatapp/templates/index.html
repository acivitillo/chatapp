<!DOCTYPE html>
<html>
  <head>
    <title>Chat REPL</title>
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.2/dist/echarts.min.js"></script>
  </head>
  <body class="bg-gray-50 font-sans">
    <div class="flex min-h-screen">
      <!-- Sidebar -->
      {% include "sidebar.html" %}

      <!-- Main Content -->
      <div class="flex-1 p-8">
        <div class="w-full mb-2">
          <button
            id="sidebar-toggle"
            onclick="toggleSidebar()"
            class="top-4 left-4 z-50 bg-white border border-gray-300 rounded-full p-2 text-gray-600 hover:bg-blue-50 shadow transition-transform"
            title="Toggle Tools Panel"
          >
            <svg
              id="sidebar-toggle-icon"
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4 transition-transform duration-200"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M9 5l7 7-7 7"
              />
            </svg>
          </button>
        </div>
        <div id="notebook" class="w-full bg-white shadow rounded p-6">
          {% include "input_cell.html" %}
          <div id="chat-window" class="space-y-2">
            <!-- Messages go here -->
          </div>
        </div>
      </div>
    </div>

    <script>
      const sendBtn = document.getElementById("send-button");
      const progressSpinner = document.getElementById("progress-spinner");
      const chatInput = document.getElementById("message-input");

      let isLoading = false;

      if (chatInput) {
        chatInput.addEventListener("input", () => {
          chatInput.style.height = "auto";
          chatInput.style.height = chatInput.scrollHeight + "px";
        });

        chatInput.addEventListener("keydown", function (e) {
          if (e.key === "Enter" && e.ctrlKey) {
            // Ctrl + Enter â†’ submit
            e.preventDefault();
            if (!isLoading) {
              sendBtn.click();
            }
          }
        });
      }

      document.addEventListener("htmx:configRequest", function (e) {
        isLoading = true;

        const form = e.detail.elt;
        const spinner = form
          .closest(".input-cell")
          ?.querySelector(".progress-spinner");
        const sendBtn = form.querySelector("button[type='submit']");

        if (sendBtn) {
          sendBtn.disabled = true;
          sendBtn.classList.add("opacity-50", "cursor-not-allowed");
        }

        if (spinner) spinner.classList.remove("hidden");
      });

      document.addEventListener("htmx:afterRequest", function (e) {
        const form = e.detail.elt;
        const spinner = form
          .closest(".input-cell")
          ?.querySelector(".progress-spinner");
        const sendBtn = form.querySelector("button[type='submit']");

        if (sendBtn) {
          sendBtn.disabled = false;
          sendBtn.classList.remove("opacity-50", "cursor-not-allowed");
        }

        if (spinner) spinner.classList.add("hidden");

        isLoading = false;
      });

      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        sidebar.classList.toggle("hidden");
      }

      // Collapsible tool nodes
      document.addEventListener("click", function (e) {
        if (e.target.closest(".collapsible-toggle")) {
          const toggleBtn = e.target.closest(".collapsible-toggle");
          const targetId = toggleBtn.getAttribute("data-target");
          const content = document.getElementById(targetId);
          const arrow = toggleBtn.querySelector("svg");

          if (content) {
            content.classList.toggle("hidden");
          }

          if (arrow) {
            arrow.classList.toggle("rotate-90");
          }
        }
      });

      function insertPromptFrom(toolName) {
        const input = document.querySelector('textarea[name="message"]');
        const rawTextElement = document.getElementById(`prompt-${toolName}`);
        if (input && rawTextElement) {
          input.value = rawTextElement.textContent.trim();
          input.focus();
          // Trigger input event to auto-resize
          input.dispatchEvent(new Event("input"));
        }
      }
    </script>

    <style>
      .markdown-desc code {
        background-color: #f3f4f6; /* Tailwind gray-100 */
        color: #1e3a8a; /* Tailwind blue-800 */
        font-family: monospace;
        font-size: 0.875rem; /* text-sm */
        padding: 0.125rem 0.25rem; /* px-1 py-0.5 */
        border-radius: 0.25rem; /* rounded */
      }
    </style>
  </body>
</html>
